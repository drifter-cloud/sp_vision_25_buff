#ifndef AUTO_AIM__PLANNER_HPP
#define AUTO_AIM__PLANNER_HPP

#include <Eigen/Dense>
#include <list>
#include <optional>

#include "io/gimbal/gimbal.hpp"
#include "tasks/auto_aim/target.hpp"
#include "tinympc/tiny_api.hpp"

namespace auto_aim
{
constexpr double DT = 0.01;
constexpr int HORIZON = 100;

using Trajectory = Eigen::Matrix<double, 4, HORIZON>;  // yaw, yaw_dot, pitch, pitch_dot

struct Plan
{
  bool control;
  bool fire;
  float yaw;
  float vyaw;
  float yaw_torque;
  float pitch;
  float vpitch;
  float pitch_torque;
};

class Planner
{
public:
  Planner(const std::string & config_path);

  Plan plan(Target target, io::GimbalState gs, bool to_now = false);
  Plan plan(std::optional<Target> target, io::GimbalState gs);

private:
  double yaw_offset_;
  double pitch_offset_;
  double fire_thresh_;

  TinySolver * yaw_solver_;
  TinySolver * pitch_solver_;

  void setup_yaw_solver(const std::string & config_path);
  void setup_pitch_solver(const std::string & config_path);

  Eigen::Matrix<double, 2, 1> observe(const Target & target, double bullet_speed) const;
  Trajectory get_trajectory(
    Target & target, double gimbal_yaw, double bullet_speed, double spin_speed);
};

}  // namespace auto_aim

#endif  // AUTO_AIM__PLANNER_HPP